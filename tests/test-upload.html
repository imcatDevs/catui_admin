<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload 테스트 - Catui</title>
  <link rel="stylesheet" href="/dist/catui.css">
  <style>
    .test-section { padding: 20px; margin-bottom: 20px; background: #fff; border-radius: 8px; }
    .test-section h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .demo-box { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start; }
    .preview-list { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
    .preview-item { width: 100px; height: 100px; border: 1px solid #eee; border-radius: 4px; overflow: hidden; }
    .preview-item img { width: 100%; height: 100%; object-fit: cover; }
  </style>
</head>
<body style="padding: 20px; background: #f5f5f5;">
  <h2>Upload 파일 업로드 테스트</h2>

  <div class="test-section">
    <h3>버튼 업로드</h3>
    <div class="demo-box">
      <button class="cui-btn cui-btn-primary" id="uploadBtn1">
        <i class="cui-icon">upload</i> 파일 선택
      </button>
      <span id="uploadResult1" style="color: #666;"></span>
    </div>
  </div>

  <div class="test-section">
    <h3>이미지 업로드 (미리보기)</h3>
    <div class="demo-box">
      <button class="cui-btn" id="uploadBtn2">
        <i class="cui-icon">image</i> 이미지 선택
      </button>
    </div>
    <div class="preview-list" id="previewList"></div>
  </div>

  <div class="test-section">
    <h3>드래그 앤 드롭</h3>
    <div id="dragArea" class="cui-upload-drag" style="width: 400px;">
      <i class="cui-icon" style="font-size: 48px; color: #999;">cloud_upload</i>
      <p>파일을 이 영역에 드래그하거나 클릭하여 업로드</p>
    </div>
    <div id="fileList" style="margin-top: 15px;"></div>
  </div>

  <div class="test-section">
    <h3>다중 파일 업로드</h3>
    <div class="demo-box">
      <button class="cui-btn cui-btn-primary" id="uploadBtn3">
        <i class="cui-icon">attach_file</i> 여러 파일 선택
      </button>
    </div>
    <div id="multiFileList" style="margin-top: 15px;"></div>
  </div>

  <div class="test-section">
    <h3>파일 크기 제한 테스트</h3>
    <p style="color: #666; margin-bottom: 15px;">
      최대 <strong>500KB</strong> 제한, 최소 <strong>1KB</strong> 이상
    </p>
    <div class="demo-box">
      <button class="cui-btn cui-btn-primary" id="uploadSize">
        <i class="cui-icon">upload</i> 파일 선택 (500KB 제한)
      </button>
    </div>
    <div id="sizeResult" style="margin-top: 15px;"></div>
  </div>

  <div class="test-section">
    <h3>확장자 제한 테스트</h3>
    <p style="color: #666; margin-bottom: 15px;">
      허용: <strong>jpg, png, gif</strong> 이미지만
    </p>
    <div class="demo-box">
      <button class="cui-btn cui-btn-primary" id="uploadExts">
        <i class="cui-icon">image</i> 이미지 선택 (jpg|png|gif)
      </button>
    </div>
    <div id="extsResult" style="margin-top: 15px;"></div>
  </div>

  <div class="test-section">
    <h3>MIME 타입 제한 테스트</h3>
    <p style="color: #666; margin-bottom: 15px;">
      허용: <strong>image/png, image/jpeg</strong> (GIF 불가)
    </p>
    <div class="demo-box">
      <button class="cui-btn" id="uploadMime">
        <i class="cui-icon">photo_camera</i> PNG/JPEG만
      </button>
    </div>
    <div id="mimeResult" style="margin-top: 15px;"></div>
  </div>

  <div class="test-section">
    <h3>복합 검증 테스트</h3>
    <p style="color: #666; margin-bottom: 15px;">
      <strong>2MB 제한</strong> + <strong>jpg|png|pdf</strong> 확장자 + 최대 <strong>3개</strong> 파일
    </p>
    <div class="demo-box">
      <button class="cui-btn cui-btn-primary" id="uploadCombo">
        <i class="cui-icon">rule</i> 복합 검증
      </button>
    </div>
    <div id="comboResult" style="margin-top: 15px;"></div>
  </div>

  <div class="test-section">
    <h3>커스텀 에러 핸들러</h3>
    <p style="color: #666; margin-bottom: 15px;">
      validateError 콜백으로 에러 상세 정보 확인
    </p>
    <div class="demo-box">
      <button class="cui-btn" id="uploadCustomErr">
        <i class="cui-icon">error_outline</i> 100KB 제한 (에러 로그)
      </button>
    </div>
    <div id="customErrResult" style="margin-top: 15px; font-family: monospace; background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 4px; max-height: 200px; overflow: auto;"></div>
  </div>

  <div class="test-section">
    <h3>모의 업로드 (진행률 표시)</h3>
    <div class="demo-box">
      <button class="cui-btn cui-btn-primary" id="uploadBtn4">
        <i class="cui-icon">cloud_upload</i> 파일 선택 후 업로드
      </button>
      <button class="cui-btn" id="startUpload4" disabled>업로드 시작</button>
    </div>
    <div id="uploadProgress" style="margin-top: 15px;"></div>
  </div>

  <div class="test-section">
    <h3>이미지 드래그 업로드 (모의)</h3>
    <div id="dragArea2" class="cui-upload-drag" style="width: 400px;">
      <i class="cui-icon" style="font-size: 48px; color: #999;">add_photo_alternate</i>
      <p>이미지를 드래그하거나 클릭하여 업로드</p>
    </div>
    <div class="preview-list" id="previewList2" style="margin-top: 15px;"></div>
  </div>

  <script src="/dist/catui.js"></script>
  <script>
    Catui.use(['$c', 'upload', 'popup'], function(){
      var upload = Catui.upload;
      var popup = Catui.popup;

      // 버튼 업로드
      upload.render({
        elem: '#uploadBtn1',
        url: 'https://httpbin.org/post',
        accept: 'file',
        auto: false,
        choose: function(obj){
          var files = obj.getFiles();
          var names = [];
          for(var key in files){
            names.push(files[key].name);
          }
          document.getElementById('uploadResult1').textContent = '선택됨: ' + names.join(', ');
        }
      });

      // 이미지 업로드 (미리보기)
      upload.render({
        elem: '#uploadBtn2',
        url: 'https://httpbin.org/post',
        accept: 'images',
        multiple: true,
        auto: false,
        choose: function(obj){
          var files = obj.getFiles();
          var previewList = document.getElementById('previewList');
          previewList.innerHTML = '';
          
          for(var key in files){
            var file = files[key];
            var reader = new FileReader();
            reader.onload = function(e){
              var div = document.createElement('div');
              div.className = 'preview-item';
              div.innerHTML = '<img src="' + e.target.result + '">';
              previewList.appendChild(div);
            };
            reader.readAsDataURL(file);
          }
        }
      });

      // 드래그 앤 드롭
      upload.render({
        elem: '#dragArea',
        url: 'https://httpbin.org/post',
        drag: true,
        auto: false,
        choose: function(obj){
          var files = obj.getFiles();
          var fileList = document.getElementById('fileList');
          fileList.innerHTML = '';
          
          for(var key in files){
            var file = files[key];
            var size = (file.size / 1024).toFixed(2) + ' KB';
            var div = document.createElement('div');
            div.style.cssText = 'padding: 8px; border: 1px solid #eee; border-radius: 4px; margin-bottom: 5px;';
            div.innerHTML = '<i class="cui-icon" style="vertical-align: middle;">description</i> ' 
              + file.name + ' <span style="color: #999;">(' + size + ')</span>';
            fileList.appendChild(div);
          }
        }
      });

      // 다중 파일 업로드
      upload.render({
        elem: '#uploadBtn3',
        url: 'https://httpbin.org/post',
        multiple: true,
        auto: false,
        choose: function(obj){
          var files = obj.getFiles();
          var list = document.getElementById('multiFileList');
          list.innerHTML = '';
          
          var count = 0;
          for(var key in files){
            count++;
          }
          
          list.innerHTML = '<span style="color: #1677ff;">' + count + '개 파일 선택됨</span>';
          
          for(var key in files){
            var file = files[key];
            var div = document.createElement('div');
            div.style.cssText = 'padding: 5px 0; border-bottom: 1px solid #eee;';
            div.textContent = file.name;
            list.appendChild(div);
          }
        }
      });

      // === 파일 크기 제한 테스트 ===
      upload.render({
        elem: '#uploadSize',
        url: '/mock-upload',
        accept: 'file',
        size: '500KB',      // 문자열 형식 지원
        minSize: '1KB',     // 최소 크기
        auto: false,
        choose: function(obj){
          var files = obj.getFiles();
          var div = document.getElementById('sizeResult');
          div.innerHTML = '';
          for(var key in files){
            var f = files[key];
            var sizeKB = (f.size / 1024).toFixed(2);
            var status = f.size <= 512000 && f.size >= 1024 
              ? '<span style="color: #52c41a;">✓ 통과</span>' 
              : '<span style="color: #ff4d4f;">✗ 실패</span>';
            div.innerHTML += '<div style="padding: 5px;">' + f.name + ' (' + sizeKB + ' KB) ' + status + '</div>';
          }
        }
      });

      // === 확장자 제한 테스트 ===
      upload.render({
        elem: '#uploadExts',
        url: '/mock-upload',
        accept: 'file',
        exts: 'jpg|png|gif',
        auto: false,
        choose: function(obj){
          var files = obj.getFiles();
          var div = document.getElementById('extsResult');
          div.innerHTML = '';
          for(var key in files){
            var f = files[key];
            var ext = f.name.split('.').pop().toLowerCase();
            var allowed = ['jpg', 'png', 'gif'];
            var status = allowed.indexOf(ext) !== -1
              ? '<span style="color: #52c41a;">✓ 허용됨</span>'
              : '<span style="color: #ff4d4f;">✗ 차단됨</span>';
            div.innerHTML += '<div style="padding: 5px;">' + f.name + ' (.' + ext + ') ' + status + '</div>';
          }
        }
      });

      // === MIME 타입 제한 테스트 ===
      upload.render({
        elem: '#uploadMime',
        url: '/mock-upload',
        accept: 'images',
        acceptMime: 'image/png, image/jpeg',
        auto: false,
        choose: function(obj){
          var files = obj.getFiles();
          var div = document.getElementById('mimeResult');
          div.innerHTML = '';
          for(var key in files){
            var f = files[key];
            var mime = f.type || 'unknown';
            var allowed = ['image/png', 'image/jpeg'];
            var status = allowed.indexOf(mime) !== -1
              ? '<span style="color: #52c41a;">✓ 허용됨</span>'
              : '<span style="color: #ff4d4f;">✗ 차단됨</span>';
            div.innerHTML += '<div style="padding: 5px;">' + f.name + ' (' + mime + ') ' + status + '</div>';
          }
        }
      });

      // === 복합 검증 테스트 ===
      upload.render({
        elem: '#uploadCombo',
        url: '/mock-upload',
        accept: 'file',
        multiple: true,
        number: 3,
        size: '2MB',
        exts: 'jpg|png|pdf',
        auto: false,
        choose: function(obj){
          var files = obj.getFiles();
          var div = document.getElementById('comboResult');
          div.innerHTML = '';
          
          var count = Object.keys(files).length;
          if(count > 3){
            div.innerHTML = '<div style="color: #ff4d4f; padding: 5px;">⚠️ 최대 3개 파일만 허용됩니다. (' + count + '개 선택됨)</div>';
          }
          
          for(var key in files){
            var f = files[key];
            var ext = f.name.split('.').pop().toLowerCase();
            var sizeOK = f.size <= 2 * 1024 * 1024;
            var extOK = ['jpg', 'png', 'pdf'].indexOf(ext) !== -1;
            var status = sizeOK && extOK
              ? '<span style="color: #52c41a;">✓</span>'
              : '<span style="color: #ff4d4f;">✗</span>';
            var details = [];
            if(!sizeOK) details.push('크기 초과');
            if(!extOK) details.push('확장자 불가');
            var detailStr = details.length > 0 ? ' (' + details.join(', ') + ')' : '';
            div.innerHTML += '<div style="padding: 5px;">' + status + ' ' + f.name + detailStr + '</div>';
          }
        }
      });

      // === 커스텀 에러 핸들러 테스트 ===
      upload.render({
        elem: '#uploadCustomErr',
        url: '/mock-upload',
        accept: 'file',
        size: '100KB',
        auto: true,  // 자동 업로드 시도 (검증 트리거)
        validateError: function(err){
          var div = document.getElementById('customErrResult');
          var log = {
            type: err.type,
            message: err.msg,
            detail: err.detail,
            fileName: err.file ? err.file.name : null,
            fileSize: err.file ? err.file.size : null,
            fileType: err.file ? err.file.type : null,
            timestamp: new Date().toISOString()
          };
          div.innerHTML += '<div style="margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 8px;">'
            + '<span style="color: #f14c4c;">[ERROR]</span> '
            + '<span style="color: #ce9178;">' + err.type + '</span>\n'
            + '<pre style="margin: 4px 0; color: #9cdcfe;">' + JSON.stringify(log, null, 2) + '</pre>'
            + '</div>';
          div.scrollTop = div.scrollHeight;
        }
      });

      // 모의 업로드 (진행률 표시)
      var mockUploadObj = null;
      upload.render({
        elem: '#uploadBtn4',
        url: '/mock-upload',  // 실제로 사용되지 않음
        multiple: true,
        auto: false,
        choose: function(obj){
          mockUploadObj = obj;
          var files = obj.getFiles();
          var progressDiv = document.getElementById('uploadProgress');
          progressDiv.innerHTML = '';
          
          for(var key in files){
            var file = files[key];
            var size = (file.size / 1024).toFixed(2) + ' KB';
            var div = document.createElement('div');
            div.id = 'progress-' + key;
            div.style.cssText = 'padding: 10px; border: 1px solid #eee; border-radius: 4px; margin-bottom: 8px;';
            div.innerHTML = '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">'
              + '<span><i class="cui-icon" style="vertical-align: middle;">description</i> ' + file.name + '</span>'
              + '<span style="color: #999;">' + size + '</span>'
              + '</div>'
              + '<div style="height: 6px; background: #eee; border-radius: 3px; overflow: hidden;">'
              + '<div class="progress-bar" style="height: 100%; width: 0%; background: var(--cui-primary); transition: width 0.3s;"></div>'
              + '</div>'
              + '<div class="progress-text" style="text-align: right; font-size: 12px; color: #999; margin-top: 3px;">대기 중</div>';
            progressDiv.appendChild(div);
          }
          
          document.getElementById('startUpload4').disabled = false;
        }
      });

      // 업로드 시작 버튼
      document.getElementById('startUpload4').addEventListener('click', function(){
        if(!mockUploadObj) return;
        
        var files = mockUploadObj.getFiles();
        var btn = this;
        btn.disabled = true;
        btn.textContent = '업로드 중...';
        
        // 모의 업로드 시뮬레이션
        var fileKeys = Object.keys(files);
        var completed = 0;
        
        fileKeys.forEach(function(key){
          var progressDiv = document.getElementById('progress-' + key);
          var progressBar = progressDiv.querySelector('.progress-bar');
          var progressText = progressDiv.querySelector('.progress-text');
          var progress = 0;
          var speed = Math.random() * 10 + 5; // 5~15% per 100ms
          
          var interval = setInterval(function(){
            progress += speed;
            if(progress >= 100){
              progress = 100;
              clearInterval(interval);
              completed++;
              progressBar.style.background = '#52c41a';
              progressText.innerHTML = '<span style="color: #52c41a;"><i class="cui-icon" style="vertical-align: middle; font-size: 14px;">check_circle</i> 완료</span>';
              
              if(completed === fileKeys.length){
                btn.textContent = '업로드 시작';
                btn.disabled = true;
                popup.msg('모든 파일 업로드 완료!', { icon: 1 });
              }
            } else {
              progressText.textContent = Math.round(progress) + '%';
            }
            progressBar.style.width = progress + '%';
          }, 100);
        });
      });

      // 이미지 드래그 업로드 (모의)
      upload.render({
        elem: '#dragArea2',
        url: '/mock-upload',
        accept: 'images',
        drag: true,
        multiple: true,
        auto: false,
        choose: function(obj){
          var files = obj.getFiles();
          var previewList = document.getElementById('previewList2');
          
          for(var key in files){
            var file = files[key];
            
            // 이미지 파일만 처리
            if(!file.type.match('image.*')){
              popup.msg('이미지 파일만 업로드 가능합니다.', { icon: 0 });
              continue;
            }
            
            (function(f, idx){
              var reader = new FileReader();
              reader.onload = function(e){
                var wrapper = document.createElement('div');
                wrapper.className = 'preview-item';
                wrapper.style.cssText = 'position: relative; width: 100px; height: 100px;';
                wrapper.innerHTML = '<img src="' + e.target.result + '" style="width: 100%; height: 100%; object-fit: cover;">'
                  + '<div class="upload-overlay" style="position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;">'
                  + '<div style="width: 60%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px;">'
                  + '<div class="img-progress" style="height: 100%; width: 0%; background: #fff; border-radius: 2px;"></div>'
                  + '</div></div>';
                previewList.appendChild(wrapper);
                
                // 모의 업로드 시뮬레이션
                var progressBar = wrapper.querySelector('.img-progress');
                var overlay = wrapper.querySelector('.upload-overlay');
                var progress = 0;
                var speed = Math.random() * 8 + 4;
                
                var interval = setInterval(function(){
                  progress += speed;
                  if(progress >= 100){
                    progress = 100;
                    clearInterval(interval);
                    overlay.innerHTML = '<i class="cui-icon" style="color: #52c41a; font-size: 32px;">check_circle</i>';
                    setTimeout(function(){
                      overlay.style.opacity = '0';
                      setTimeout(function(){ overlay.remove(); }, 300);
                    }, 500);
                  }
                  progressBar.style.width = progress + '%';
                }, 100);
              };
              reader.readAsDataURL(f);
            })(file, key);
          }
        }
      });
    });
  </script>
</body>
</html>
