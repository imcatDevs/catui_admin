<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CatUI Admin</title>
  <link rel="stylesheet" href="/dist/catui.css">
</head>
<body class="cui-layout-body">
  <div class="cui-layout-admin cui-theme-light">
    <!-- 사이드바 -->
    <div class="cui-side cui-side-dark" id="cuiSide">
      <div class="cui-side-logo">
        <a href="#" class="header-brand" catui-href="views/home.html" title="홈으로 이동">
        <img src="assets/imcatdev.svg" alt="CATUI Logo" class="header-logo">
      </a>
      </div>
      <ul class="cui-menu" id="sideMenu">
        <!-- 메뉴는 JSON에서 동적으로 로드됩니다 -->
      </ul>
      <!-- 사이드바 하단 -->
      <div class="cui-side-footer">
        <a href="javascript:;" onclick="openThemePanel()" title="테마 설정"><i class="cui-icon">palette</i></a>
        <a href="javascript:;" onclick="toggleDarkMode()" title="다크모드 전환"><i class="cui-icon" id="darkModeIcon">dark_mode</i></a>
      </div>
    </div>
    
    <!-- 우측 영역 -->
    <div class="cui-main-wrap" id="cuiMainWrap">
      <!-- 상단 헤더 -->
      <div class="cui-header">
        <a href="javascript:;" class="cui-sidebar-toggle" onclick="toggleSidebar()" title="사이드바 토글" style="flex-shrink: 0;">
          <i class="cui-icon">menu</i>
        </a>
       
      </div>
      
      <!-- 페이지 탭 바 -->
      <div class="cui-pagetabs" id="cuiPagetabs" style="display: none;">
        <div class="cui-pagetabs-control cui-pagetabs-prev"><i class="cui-icon">chevron_left</i></div>
        <div class="cui-pagetabs-control cui-pagetabs-next"><i class="cui-icon">chevron_right</i></div>
        <div class="cui-pagetabs-control cui-pagetabs-more">
          <i class="cui-icon">expand_more</i>
          <ul class="cui-pagetabs-dropdown">
            <li data-action="closeThis"><a href="javascript:;">현재 탭 닫기</a></li>
            <li data-action="closeOther"><a href="javascript:;">다른 탭 모두 닫기</a></li>
            <li data-action="closeAll"><a href="javascript:;">모든 탭 닫기</a></li>
          </ul>
        </div>
        <div class="cui-pagetabs-wrap">
          <ul class="cui-pagetabs-list">
            <!-- 탭이 동적으로 추가됨 -->
          </ul>
        </div>
      </div>
      
      <!-- 메인 컨텐츠 -->
      <div class="cui-body">
        <div class="cui-main">
          <div cui-target-content>
            <div class="cui-text-center cui-p-20">
              <h2>CatUI Admin</h2>
              <p class="cui-text-secondary">왼쪽 메뉴를 클릭하여 페이지를 로드해보세요.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/dist/catui.js"></script>
  <script>
    // 메뉴 HTML 생성 함수
    function buildMenuHTML(items, depth){
      depth = depth || 0;
      var html = '';
      
      items.forEach(function(item){
        var hasChildren = item.children && item.children.length > 0;
        var openClass = item.open ? ' cui-menu-open' : '';
        
        html += '<li class="cui-menu-item' + openClass + '">';
        
        if(hasChildren){
          // 서브메뉴가 있는 경우
          html += '<a href="javascript:;" class="cui-menu-toggle">';
          html += '<i class="cui-icon">' + item.icon + '</i>';
          html += '<span>' + item.title + '</span>';
          html += '<i class="cui-icon cui-menu-arrow">expand_more</i>';
          html += '</a>';
          html += '<ul class="cui-menu-sub">';
          html += buildMenuHTML(item.children, depth + 1);
          html += '</ul>';
        } else {
          // 링크 메뉴
          html += '<a cui-href="' + item.href + '">';
          html += '<i class="cui-icon">' + item.icon + '</i>';
          html += '<span>' + item.title + '</span>';
          html += '</a>';
        }
        
        html += '</li>';
      });
      
      return html;
    }
    
    // 메뉴 JSON 로드
    function loadMenu(callback){
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/examples/router/menu.json', true);
      xhr.onreadystatechange = function(){
        if(xhr.readyState === 4){
          if(xhr.status === 200){
            try {
              var menuData = JSON.parse(xhr.responseText);
              var menuHTML = buildMenuHTML(menuData);
              document.getElementById('sideMenu').innerHTML = menuHTML;
              if(callback) callback(menuData);
            } catch(e){
              console.error('[Menu] JSON 파싱 실패:', e);
            }
          } else {
            console.error('[Menu] 로드 실패:', xhr.status);
          }
        }
      };
      xhr.send();
    }
    
    // 메뉴에서 페이지 이름 정보 추출
    function getPageTabNamesFromMenu(){
      var names = {};
      document.querySelectorAll('.cui-menu-item a[cui-href]').forEach(function(link){
        var href = link.getAttribute('cui-href');
        var filename = href.split('/').pop();
        var icon = link.querySelector('.cui-icon');
        var text = link.querySelector('span');
        names[filename] = {
          name: text ? text.textContent : filename,
          icon: icon ? icon.textContent : 'description'
        };
      });
      return names;
    }
    
    // 메뉴 로드 후 라우터 초기화
    loadMenu(function(menuData){
      initRouter();
    });
    
    // 라우터 및 테마 모듈 로드
    function initRouter(){
    Catui.use(['router', 'theme', 'popup', 'pagetabs', 'element'], function(){
      
      // 페이지 탭 설정
      pagetabs.set({
        container: '#cuiPagetabs',
        homeTab: false,
        homePath: '/examples/router/pages/home.html',
        onChange: function(tab){
          // 탭 변경 시 페이지 로드
          if(tab && tab.path && !tab.isHome){
            router.loadRoute(tab.path);
          }
        }
      });
      
      // 페이지 탭 초기화
      pagetabs.init();
      
      // 라우터 설정
      router.set({
        cache: true,
        transition: true,
        activeClass: 'cui-menu-active',
        
        // 페이지 탭 설정
        pageTabs: true,
        pageTabsNames: getPageTabNamesFromMenu(),
        
        beforeEach: function(to){
          return true;
        },
        
        afterEach: function(to){
          // 페이지 로드 완료 후 element 렌더링
          element.render();
        },
        
        onError: function(xhr, status, path){
          console.error('[Router] 에러:', status, path);
          if(window.popup){
            popup.msg('페이지를 불러올 수 없습니다: ' + path, { icon: 2 });
          } else {
            alert('페이지를 불러올 수 없습니다: ' + path);
          }
        }
      });
      
      // 초기 페이지 로드
      if(!location.hash){
        router.go('/examples/router/pages/home.html');
      }
      
      // 테마 변경 이벤트
      theme.on('change', function(data){
        updateDarkModeIcon(data.isDark);
      });
    });
    } // initRouter 함수 종료
    
    // 하위 메뉴 토글 (아코디언 방식)
    document.addEventListener('click', function(e){
      var toggle = e.target.closest('.cui-menu-toggle');
      if(toggle){
        e.preventDefault();
        var parent = toggle.closest('.cui-menu-item');
        if(parent && parent.querySelector('.cui-menu-sub')){
          var isOpen = parent.classList.contains('cui-menu-open');
          
          // 같은 레벨의 다른 열린 메뉴 닫기
          var siblings = parent.parentElement.querySelectorAll(':scope > .cui-menu-item.cui-menu-open');
          siblings.forEach(function(item){
            if(item !== parent){
              item.classList.remove('cui-menu-open');
            }
          });
          
          // 현재 메뉴 토글
          parent.classList.toggle('cui-menu-open');
        }
      }
    });
    
    // 사이드바 토글
    function toggleSidebar(){
      var layout = document.querySelector('.cui-layout-admin');
      layout.classList.toggle('cui-sidebar-collapsed');
    }
    
    // 테마 패널 열기
    function openThemePanel(){
      var themeList = theme.list();
      var currentTheme = theme.current();
      
      var html = '<div class="cui-p-15">';
      html += '<h4 class="cui-mb-15">테마 선택</h4>';
      html += '<div class="theme-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">';
      
      for(var key in themeList){
        var t = themeList[key];
        var isActive = currentTheme === key ? ' theme-active' : '';
        var border = key === 'light' ? 'border: 1px solid #ddd;' : '';
        html += '<div class="theme-item' + isActive + '" data-theme="' + key + '" style="cursor: pointer; text-align: center;">';
        html += '<div style="width: 100%; height: 40px; background: ' + t.header + '; border-radius: 4px; margin-bottom: 5px; ' + border + '"></div>';
        html += '<span style="font-size: 12px;">' + t.name + '</span>';
        html += '</div>';
      }
      
      html += '</div>';
      html += '<hr class="cui-mt-15 cui-mb-15">';
      html += '<h4 class="cui-mb-15">커스텀 Primary 색상</h4>';
      html += '<div style="display: flex; gap: 10px; align-items: center;">';
      html += '<input type="color" id="customPrimary" value="#16baaa" style="width: 50px; height: 35px; border: none; cursor: pointer;">';
      html += '<button class="cui-btn cui-btn-sm" onclick="applyCustomColor()">적용</button>';
      html += '</div>';
      html += '</div>';
      
      popup.open({
        type: 'drawer',
        title: '테마 설정',
        area: '320px',
        offset: 'r',
        content: html,
        success: function(layero){
          // 테마 아이템 클릭 이벤트
          layero.querySelectorAll('.theme-item').forEach(function(item){
            item.addEventListener('click', function(){
              var themeName = this.getAttribute('data-theme');
              theme.set(themeName);
              
              // 활성 상태 변경
              layero.querySelectorAll('.theme-item').forEach(function(el){
                el.classList.remove('theme-active');
              });
              this.classList.add('theme-active');
              
              popup.msg(themeList[themeName].name + ' 테마 적용됨', { icon: 1 });
            });
          });
        }
      });
    }
    
    // 커스텀 색상 적용
    function applyCustomColor(){
      var color = document.getElementById('customPrimary').value;
      theme.setPrimary(color);
      popup.msg('커스텀 색상 적용됨: ' + color, { icon: 1 });
    }
    
    // 다크모드 토글
    function toggleDarkMode(){
      var current = theme.current();
      if(current === 'dark'){
        theme.set('light');
      } else {
        theme.set('dark');
      }
    }
    
    // 다크모드 아이콘 업데이트
    function updateDarkModeIcon(isDark){
      var icon = document.getElementById('darkModeIcon');
      if(icon){
        icon.textContent = isDark ? 'light_mode' : 'dark_mode';
      }
    }
  </script>
  
  <style>
    .theme-item { transition: transform 0.2s; }
    .theme-item:hover { transform: scale(1.05); }
    .theme-active { outline: 2px solid var(--cui-primary); outline-offset: 2px; border-radius: 4px; }
  </style>
</body>
</html>
