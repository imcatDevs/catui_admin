<div class="cui-fluid">
  <!-- 페이지 헤더 -->
  <div class="cui-page-header cui-mb-15">
    <div class="cui-page-title-wrap">
      <h2 class="cui-page-title">게시글 수정</h2>
      <button type="button" class="cui-page-refresh" onclick="router.refresh()"><i class="cui-icon">refresh</i></button>
    </div>
    <div class="cui-breadcrumb">
      <a href="javascript:;">홈</a>
      <a href="javascript:;" onclick="router.go('/examples/router/pages/board-list.html')">게시판</a>
      <span>수정</span>
    </div>
  </div>

  <!-- 수정 폼 -->
  <div class="cui-card">
    <div class="cui-card-header cui-flex cui-flex-between cui-flex-middle">
      <span>게시글 수정</span>
      <span class="cui-text-secondary" id="boardInfo"></span>
    </div>
    <div class="cui-card-body">
      <form class="cui-form" cui-filter="boardEditForm">
        <input type="hidden" name="id" id="boardId">
        
        <div class="cui-form-item">
          <label class="cui-form-label cui-form-required">구분</label>
          <div class="cui-form-input">
            <select name="status" id="boardStatus" class="cui-select" cui-verify="required">
              <option value="">선택하세요</option>
              <option value="일반">일반</option>
              <option value="공지">공지</option>
            </select>
          </div>
        </div>

        <div class="cui-form-item">
          <label class="cui-form-label cui-form-required">제목</label>
          <div class="cui-form-input">
            <input type="text" name="title" id="boardTitle" class="cui-input" placeholder="제목을 입력하세요" cui-verify="required" maxlength="100">
          </div>
        </div>

        <div class="cui-form-item">
          <label class="cui-form-label cui-form-required">내용</label>
          <div class="cui-form-input">
            <textarea name="content" id="boardContent" class="cui-textarea" placeholder="내용을 입력하세요" cui-verify="required" style="height: 300px;"></textarea>
          </div>
        </div>

        <div class="cui-form-item">
          <label class="cui-form-label">기존 첨부파일</label>
          <div class="cui-form-input">
            <div id="existingFiles"></div>
          </div>
        </div>

        <div class="cui-form-item">
          <label class="cui-form-label">새 첨부파일</label>
          <div class="cui-form-input">
            <div id="uploadArea">
              <button type="button" class="cui-btn" id="btnUpload"><i class="cui-icon">attach_file</i> 파일 추가</button>
              <span class="cui-text-secondary cui-ml-10">최대 10MB, jpg/png/pdf 허용</span>
            </div>
            <div id="newFileList" class="cui-mt-10"></div>
          </div>
        </div>

        <div class="cui-form-item">
          <label class="cui-form-label">작성자</label>
          <div class="cui-form-input">
            <input type="text" name="writer" id="boardWriter" class="cui-input" readonly style="width: 200px;">
          </div>
        </div>

        <div class="cui-form-item">
          <div class="cui-form-input">
            <button type="submit" class="cui-btn cui-btn-primary cui-btn-lg"><i class="cui-icon">save</i> 수정 완료</button>
            <button type="button" class="cui-btn cui-btn-lg" id="btnView"><i class="cui-icon">visibility</i> 상세보기</button>
            <button type="button" class="cui-btn cui-btn-lg" id="btnCancel"><i class="cui-icon">arrow_back</i> 목록</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
Catui.use(['form', 'popup', 'upload'], function(){
  // URL에서 ID 파싱
  var query = router.getQuery ? router.getQuery() : {};
  var boardId = query.id || 1;

  // 샘플 데이터 로드 (실제로는 API 호출)
  var boardData = {
    id: boardId,
    status: boardId % 3 === 0 ? '공지' : '일반',
    title: '게시글 제목 ' + boardId + ' - 샘플 데이터입니다',
    content: '안녕하세요.\n\n이것은 게시글 ' + boardId + '번의 상세 내용입니다.\n\nCatUI 프레임워크를 사용한 게시판 CRUD 예제입니다.',
    writer: ['홍길동', '김철수', '이영희', '박지민', '최수진'][boardId % 5],
    date: '2024-12-10 14:30',
    files: boardId % 2 === 0 ? [
      { id: 1, name: '첨부파일1.pdf', size: '2.5MB' },
      { id: 2, name: '이미지.png', size: '1.2MB' }
    ] : []
  };

  // 폼에 데이터 채우기
  document.getElementById('boardId').value = boardData.id;
  document.getElementById('boardTitle').value = boardData.title;
  document.getElementById('boardContent').value = boardData.content;
  document.getElementById('boardWriter').value = boardData.writer;
  document.getElementById('boardInfo').textContent = '게시글 #' + boardData.id + ' | 최종수정: ' + boardData.date;

  // select 값 설정
  setTimeout(function(){
    document.getElementById('boardStatus').value = boardData.status;
    form.render('select');
  }, 100);

  // 기존 첨부파일 표시
  if(boardData.files.length > 0){
    var fileHtml = '';
    boardData.files.forEach(function(file){
      fileHtml += '<div class="cui-flex cui-flex-middle cui-mb-5" data-file-id="' + file.id + '">';
      fileHtml += '<i class="cui-icon cui-mr-5">insert_drive_file</i>';
      fileHtml += '<span>' + file.name + '</span>';
      fileHtml += '<span class="cui-text-secondary cui-ml-5">(' + file.size + ')</span>';
      fileHtml += '<a href="javascript:;" class="cui-text-danger cui-ml-10" onclick="removeExistingFile(this, ' + file.id + ')"><i class="cui-icon">close</i></a>';
      fileHtml += '</div>';
    });
    document.getElementById('existingFiles').innerHTML = fileHtml;
  } else {
    document.getElementById('existingFiles').innerHTML = '<span class="cui-text-secondary">첨부파일 없음</span>';
  }

  // 기존 파일 삭제
  window.removeExistingFile = function(el, fileId){
    popup.confirm('이 파일을 삭제하시겠습니까?', { icon: 'warning' }, function(idx){
      popup.close(idx);
      el.closest('[data-file-id]').remove();
      popup.msg('파일이 삭제되었습니다');
      
      // 남은 파일 확인
      if(document.getElementById('existingFiles').children.length === 0){
        document.getElementById('existingFiles').innerHTML = '<span class="cui-text-secondary">첨부파일 없음</span>';
      }
    });
  };

  // 폼 렌더링
  form.render();

  // 새 파일 업로드
  upload.render({
    elem: '#btnUpload',
    url: '/api/upload',
    accept: 'file',
    exts: 'jpg|png|pdf',
    size: 10240,
    multiple: true,
    before: function(){
      popup.load(1);
    },
    done: function(res){
      popup.closeAll('loading');
      if(res.code === 0){
        var html = '<div class="cui-flex cui-flex-middle cui-mb-5">';
        html += '<i class="cui-icon cui-mr-5">insert_drive_file</i>';
        html += '<span>' + res.data.filename + '</span>';
        html += '<a href="javascript:;" class="cui-text-danger cui-ml-10" onclick="this.parentNode.remove()"><i class="cui-icon">close</i></a>';
        html += '</div>';
        document.getElementById('newFileList').insertAdjacentHTML('beforeend', html);
        popup.msg('업로드 완료');
      }
    },
    error: function(){
      popup.closeAll('loading');
      popup.msg('업로드 실패 (데모용 - 실제 서버 없음)', { icon: 'info' });
    }
  });

  // 폼 제출
  form.on('submit(boardEditForm)', function(data){
    console.log('수정 데이터:', data.field);
    
    popup.confirm('게시글을 수정하시겠습니까?', { icon: 'help' }, function(idx){
      popup.close(idx);
      popup.load(1);
      
      setTimeout(function(){
        popup.closeAll('loading');
        popup.msg('수정이 완료되었습니다', { icon: 'success' });
        
        setTimeout(function(){
          router.go('/examples/router/pages/board-view.html?id=' + boardId);
        }, 500);
      }, 1000);
    });
    
    return false;
  });

  // 상세보기
  document.getElementById('btnView').addEventListener('click', function(){
    router.go('/examples/router/pages/board-view.html?id=' + boardId);
  });

  // 목록으로
  document.getElementById('btnCancel').addEventListener('click', function(){
    popup.confirm('수정을 취소하시겠습니까?<br>변경 내용은 저장되지 않습니다.', { icon: 'warning' }, function(idx){
      popup.close(idx);
      router.go('/examples/router/pages/board-list.html');
    });
  });
});
</script>
</div>
