<div class="cui-fluid">
  <!-- 페이지 헤더 -->
  <div class="cui-page-header cui-mb-15">
    <div class="cui-page-title-wrap">
      <h2 class="cui-page-title">Flow 무한 스크롤</h2>
    </div>
    <div class="cui-breadcrumb">
      <a href="javascript:;">홈</a>
      <a href="javascript:;">컴포넌트</a>
      <span>Flow</span>
    </div>
  </div>

  <!-- 기본 사용법 -->
  <div class="cui-card cui-mb-15">
    <div class="cui-card-header">기본 사용법</div>
    <div class="cui-card-body">
      <p class="cui-mb-15">스크롤이 하단에 도달하면 자동으로 다음 데이터를 로드합니다.</p>
      <div class="flow-demo" id="flowContainer1">
        <div class="flow-content" id="flowContent1"></div>
      </div>
      <div class="cui-mt-15">
        <button class="cui-btn cui-btn-sm" id="btnReload1"><i class="cui-icon">refresh</i> 다시 로드</button>
      </div>
    </div>
  </div>

  <!-- 뉴스 피드 스타일 -->
  <div class="cui-card cui-mb-15">
    <div class="cui-card-header">뉴스 피드 스타일</div>
    <div class="cui-card-body cui-p-0">
      <div class="flow-demo" id="flowContainer2">
        <div class="flow-content" id="flowContent2"></div>
      </div>
    </div>
  </div>

  <!-- 카드 그리드 -->
  <div class="cui-card cui-mb-15">
    <div class="cui-card-header">카드 그리드</div>
    <div class="cui-card-body">
      <div class="flow-demo" id="flowContainer3">
        <div class="flow-grid" id="flowContent3"></div>
      </div>
    </div>
  </div>

  <!-- 수동 로드 -->
  <div class="cui-card">
    <div class="cui-card-header">수동 로드 (버튼 클릭)</div>
    <div class="cui-card-body">
      <div id="flowContent4"></div>
      <div class="cui-text-center cui-mt-15">
        <button class="cui-btn cui-btn-primary" id="btnLoadMore"><i class="cui-icon">add</i> 더 불러오기</button>
      </div>
    </div>
  </div>
</div>

<style>
.flow-demo {
  max-height: 400px;
  overflow-y: auto;
  border: 1px solid var(--cui-border);
  border-radius: 8px;
}

.flow-item {
  padding: 15px;
  border-bottom: 1px solid var(--cui-border);
}

.flow-item:last-child { border-bottom: none; }
.flow-item h4 { margin: 0 0 8px; font-size: 15px; }
.flow-item p { margin: 0; color: var(--cui-text-secondary); font-size: 13px; }

/* 뉴스 스타일 */
.news-item {
  display: flex;
  gap: 15px;
  padding: 15px;
  border-bottom: 1px solid var(--cui-border);
  transition: background 0.2s;
}

.news-item:hover { background: var(--cui-fill); }

.news-thumb {
  width: 120px;
  height: 80px;
  border-radius: 6px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: rgba(255,255,255,0.5);
}

.news-content { flex: 1; min-width: 0; }
.news-title { font-size: 15px; font-weight: 500; margin: 0 0 8px; line-height: 1.5; }
.news-title a { color: var(--cui-text); text-decoration: none; }
.news-title a:hover { color: var(--cui-primary); }
.news-desc { font-size: 13px; color: var(--cui-text-secondary); margin: 0 0 8px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.news-meta { font-size: 12px; color: var(--cui-text-muted); }
.news-meta span { margin-right: 15px; }

/* 카드 그리드 */
.flow-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
  padding: 15px;
}

.grid-card {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
}

.grid-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

.grid-card-img {
  height: 120px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: rgba(255,255,255,0.5);
}

.grid-card-body { padding: 12px; }
.grid-card-title { font-size: 14px; font-weight: 500; margin: 0 0 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.grid-card-desc { font-size: 12px; color: var(--cui-text-secondary); margin: 0; }

/* 로딩/종료 */
.cui-flow-loading, .cui-flow-end {
  text-align: center;
  padding: 20px;
  color: var(--cui-text-secondary);
  font-size: 14px;
}

.cui-flow-loading .cui-icon { margin-right: 8px; }
</style>

<script>
Catui.use(['flow', 'popup'], function(){
  var flowInst1, flowInst2, flowInst3;
  var page1 = 1, page2 = 1, page3 = 1, page4 = 1;
  var maxPage = 5;

  // 데이터 생성 함수
  function generateItems(page, type){
    var items = [];
    var start = (page - 1) * 10;
    for(var i = 0; i < 10; i++){
      var idx = start + i + 1;
      items.push({
        id: idx,
        title: '아이템 #' + idx,
        desc: '이것은 아이템 ' + idx + '의 설명입니다. 무한 스크롤로 로드된 컨텐츠입니다.',
        date: '2024-01-' + String(Math.floor(Math.random() * 28) + 1).padStart(2, '0'),
        views: Math.floor(Math.random() * 1000),
        color: ['#1677ff', '#52c41a', '#faad14', '#eb2f96', '#722ed1'][idx % 5]
      });
    }
    return items;
  }

  // 기본 리스트 렌더링
  function renderBasicList(items, container){
    var html = items.map(function(item){
      return '<div class="flow-item">' +
        '<h4>' + item.title + '</h4>' +
        '<p>' + item.desc + '</p>' +
      '</div>';
    }).join('');
    document.getElementById(container).insertAdjacentHTML('beforeend', html);
  }

  // 뉴스 리스트 렌더링
  function renderNewsList(items, container){
    var html = items.map(function(item){
      return '<div class="news-item">' +
        '<div class="news-thumb" style="background:' + item.color + ';"><i class="cui-icon" style="font-size:32px;">image</i></div>' +
        '<div class="news-content">' +
          '<h4 class="news-title"><a href="javascript:;">' + item.title + ' - 뉴스 제목이 여기에 표시됩니다</a></h4>' +
          '<p class="news-desc">' + item.desc + ' 뉴스 내용의 일부가 미리보기로 표시됩니다.</p>' +
          '<div class="news-meta"><span><i class="cui-icon" style="font-size:14px;">schedule</i> ' + item.date + '</span><span><i class="cui-icon" style="font-size:14px;">visibility</i> ' + item.views + '</span></div>' +
        '</div>' +
      '</div>';
    }).join('');
    document.getElementById(container).insertAdjacentHTML('beforeend', html);
  }

  // 카드 그리드 렌더링
  function renderGridCards(items, container){
    var html = items.map(function(item){
      return '<div class="grid-card">' +
        '<div class="grid-card-img" style="background:linear-gradient(135deg,' + item.color + ',#2c3e50);"><i class="cui-icon" style="font-size:36px;">image</i></div>' +
        '<div class="grid-card-body">' +
          '<h4 class="grid-card-title">' + item.title + '</h4>' +
          '<p class="grid-card-desc">' + item.views + ' views</p>' +
        '</div>' +
      '</div>';
    }).join('');
    document.getElementById(container).insertAdjacentHTML('beforeend', html);
  }

  // Flow 1: 기본 리스트
  flowInst1 = flow.render({
    elem: '#flowContent1',
    scrollElem: '#flowContainer1',
    done: function(page, next){
      setTimeout(function(){
        if(page1 > maxPage){
          next('', true);
          return;
        }
        var items = generateItems(page1, 'basic');
        renderBasicList(items, 'flowContent1');
        page1++;
        next();
      }, 500);
    }
  });

  // Flow 2: 뉴스 피드
  flowInst2 = flow.render({
    elem: '#flowContent2',
    scrollElem: '#flowContainer2',
    done: function(page, next){
      setTimeout(function(){
        if(page2 > maxPage){
          next('', true);
          return;
        }
        var items = generateItems(page2, 'news');
        renderNewsList(items, 'flowContent2');
        page2++;
        next();
      }, 500);
    }
  });

  // Flow 3: 카드 그리드
  flowInst3 = flow.render({
    elem: '#flowContent3',
    scrollElem: '#flowContainer3',
    done: function(page, next){
      setTimeout(function(){
        if(page3 > maxPage){
          next('', true);
          return;
        }
        var items = generateItems(page3, 'grid');
        renderGridCards(items, 'flowContent3');
        page3++;
        next();
      }, 500);
    }
  });

  // Flow 4: 수동 로드 (초기 데이터)
  var items4 = generateItems(1, 'basic');
  renderBasicList(items4, 'flowContent4');
  page4 = 2;

  // 버튼 이벤트 - router 인스턴스 관리 API 사용
  var bindEvent = window.router ? router.bindEvent.bind(router) : function(el, type, fn){
    document.querySelector(el).addEventListener(type, fn);
  };

  // 다시 로드
  bindEvent('#btnReload1', 'click', function(){
    document.getElementById('flowContent1').innerHTML = '';
    page1 = 1;
    if(flowInst1) flowInst1.reload();
    popup.msg('다시 로드합니다');
  });

  // 수동 더 불러오기
  bindEvent('#btnLoadMore', 'click', function(){
    if(page4 > maxPage){
      popup.msg('더 이상 데이터가 없습니다');
      return;
    }
    var btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="cui-icon cui-anim cui-anim-rotate">sync</i> 로딩 중...';
    
    setTimeout(function(){
      var items = generateItems(page4, 'basic');
      renderBasicList(items, 'flowContent4');
      page4++;
      btn.disabled = false;
      btn.innerHTML = '<i class="cui-icon">add</i> 더 불러오기';
      
      if(page4 > maxPage){
        btn.innerHTML = '<i class="cui-icon">check</i> 모두 로드됨';
        btn.disabled = true;
      }
    }, 500);
  });

  // 페이지 이동 시 정리 - router 인스턴스 관리 API 사용
  if(window.router){
    router.addCleanup(function(){
      // flow 인스턴스의 스크롤 이벤트 정리는 flow 모듈 내부에서 처리
      flowInst1 = null;
      flowInst2 = null;
      flowInst3 = null;
    });
  }
});
</script>
