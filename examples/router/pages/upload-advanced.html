<div class="cui-fluid">
  <!-- í˜ì´ì§€ í—¤ë” -->
  <div class="cui-page-header cui-mb-15">
    <div class="cui-page-title-wrap">
      <h2 class="cui-page-title">íŒŒì¼ ì—…ë¡œë“œ - ê³ ê¸‰</h2>
      <button type="button" class="cui-page-refresh" onclick="router.refresh()"><i class="cui-icon">refresh</i></button>
    </div>
    <div class="cui-breadcrumb">
      <a href="javascript:;">í™ˆ</a>
      <a href="javascript:;">ì»´í¬ë„ŒíŠ¸</a>
      <span>ì—…ë¡œë“œ ê³ ê¸‰</span>
    </div>
  </div>

  <!-- ì§„í–‰ë¥  í‘œì‹œ -->
  <div class="cui-card cui-mb-15">
    <div class="cui-card-header cui-flex cui-flex-between cui-flex-middle">
      <span>ì§„í–‰ë¥  í‘œì‹œ</span>
      <code class="cui-text-secondary">progress: function(percent){ }</code>
    </div>
    <div class="cui-card-body">
      <p class="cui-text-secondary cui-mb-10">ì—…ë¡œë“œ ì§„í–‰ë¥ ì„ í‘œì‹œí•©ë‹ˆë‹¤.</p>
      <button id="uploadProgress" class="cui-btn cui-btn-primary"><i class="cui-icon">upload</i> ì—…ë¡œë“œ (ì§„í–‰ë¥ )</button>
      <div id="progressBar" class="cui-mt-10" style="display:none;">
        <div class="cui-progress">
          <div class="cui-progress-bar" style="width:0%"></div>
        </div>
        <div class="cui-text-center cui-mt-5"><span id="progressText">0%</span></div>
      </div>
    </div>
  </div>

  <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
  <div class="cui-card cui-mb-15">
    <div class="cui-card-header cui-flex cui-flex-between cui-flex-middle">
      <span>ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span>
      <code class="cui-text-secondary">choose â†’ preview()</code>
    </div>
    <div class="cui-card-body">
      <p class="cui-text-secondary cui-mb-10">ì„ íƒí•œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ ì „ì— ë¯¸ë¦¬ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <button id="uploadPreview" class="cui-btn"><i class="cui-icon">image</i> ì´ë¯¸ì§€ ì„ íƒ</button>
      <div id="previewArea" class="cui-mt-10 cui-flex cui-gap-10 cui-flex-wrap"></div>
    </div>
  </div>

  <!-- ì•„ë°”íƒ€ ì—…ë¡œë“œ -->
  <div class="cui-card cui-mb-15">
    <div class="cui-card-header cui-flex cui-flex-between cui-flex-middle">
      <span>ì•„ë°”íƒ€ ì—…ë¡œë“œ</span>
      <code class="cui-text-secondary">ë‹¨ì¼ ì´ë¯¸ì§€ êµì²´</code>
    </div>
    <div class="cui-card-body">
      <div class="cui-flex cui-gap-15 cui-flex-middle">
        <div id="avatarUpload" class="avatar-upload-area">
          <img id="avatarImg" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23e0e0e0'/%3E%3Cpath d='M50 55c11 0 20-9 20-20s-9-20-20-20-20 9-20 20 9 20 20 20zm0 10c-13 0-40 7-40 20v10h80v-10c0-13-27-20-40-20z' fill='%23bdbdbd'/%3E%3C/svg%3E" alt="avatar">
          <div class="avatar-upload-overlay">
            <i class="cui-icon">photo_camera</i>
          </div>
        </div>
        <div>
          <div class="cui-text-secondary cui-text-sm">í´ë¦­í•˜ì—¬ í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½</div>
          <div class="cui-text-secondary cui-text-xs">JPG, PNG (ìµœëŒ€ 2MB)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- íŒŒì¼ ëª©ë¡ ê´€ë¦¬ -->
  <div class="cui-card cui-mb-15">
    <div class="cui-card-header cui-flex cui-flex-between cui-flex-middle">
      <span>íŒŒì¼ ëª©ë¡ ê´€ë¦¬</span>
      <code class="cui-text-secondary">ì„ íƒ â†’ ëª©ë¡ â†’ ê°œë³„ ì‚­ì œ/ì—…ë¡œë“œ</code>
    </div>
    <div class="cui-card-body">
      <p class="cui-text-secondary cui-mb-10">ì„ íƒí•œ íŒŒì¼ì„ ëª©ë¡ìœ¼ë¡œ ê´€ë¦¬í•˜ê³  ê°œë³„ì ìœ¼ë¡œ ì—…ë¡œë“œ/ì‚­ì œí•©ë‹ˆë‹¤.</p>
      <div class="cui-flex cui-gap-10 cui-mb-10">
        <button id="addFiles" class="cui-btn"><i class="cui-icon">add</i> íŒŒì¼ ì¶”ê°€</button>
        <button id="uploadAll" class="cui-btn cui-btn-primary"><i class="cui-icon">cloud_upload</i> ì „ì²´ ì—…ë¡œë“œ</button>
        <button id="clearAll" class="cui-btn cui-btn-danger"><i class="cui-icon">delete</i> ì „ì²´ ì‚­ì œ</button>
      </div>
      <div id="fileList" class="file-list"></div>
    </div>
  </div>

  <!-- ì¶”ê°€ ë°ì´í„° ì „ì†¡ -->
  <div class="cui-card cui-mb-15">
    <div class="cui-card-header cui-flex cui-flex-between cui-flex-middle">
      <span>ì¶”ê°€ ë°ì´í„° ì „ì†¡</span>
      <code class="cui-text-secondary">data: { key: value }</code>
    </div>
    <div class="cui-card-body">
      <p class="cui-text-secondary cui-mb-10">íŒŒì¼ê³¼ í•¨ê»˜ ì¶”ê°€ ë°ì´í„°ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.</p>
      <div class="cui-form-inline cui-flex-middle cui-mb-10">
        <div class="cui-form-item">
          <label class="cui-form-label">ì¹´í…Œê³ ë¦¬</label>
          <div class="cui-form-input">
            <select id="category" class="cui-select">
              <option value="document">ë¬¸ì„œ</option>
              <option value="image">ì´ë¯¸ì§€</option>
              <option value="other">ê¸°íƒ€</option>
            </select>
          </div>
        </div>
        <div class="cui-form-item" style="flex:1;">
          <label class="cui-form-label">ì„¤ëª…</label>
          <div class="cui-form-input" style="display:flex;gap:10px;">
            <input type="text" id="description" class="cui-input" placeholder="íŒŒì¼ ì„¤ëª…" style="flex:1;">
            <button id="uploadWithData" class="cui-btn cui-btn-primary"><i class="cui-icon">upload</i> ì—…ë¡œë“œ</button>
          </div>
        </div>
      </div>
      <div id="dataResult" class="cui-text-secondary cui-text-sm"></div>
    </div>
  </div>

  <!-- ì½œë°± ì¢…í•© -->
  <div class="cui-card">
    <div class="cui-card-header cui-flex cui-flex-between cui-flex-middle">
      <span>ì½œë°± ì¢…í•©</span>
      <code class="cui-text-secondary">before / done / error / allDone</code>
    </div>
    <div class="cui-card-body">
      <p class="cui-text-secondary cui-mb-10">ì—…ë¡œë“œ ê³¼ì •ì˜ ëª¨ë“  ì½œë°±ì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
      <button id="uploadCallback" class="cui-btn cui-btn-primary"><i class="cui-icon">upload</i> ì—¬ëŸ¬ íŒŒì¼ ì—…ë¡œë“œ</button>
      <div id="callbackLog" class="cui-mt-10" style="height:150px;overflow:auto;background:#f5f5f5;padding:10px;border-radius:4px;font-size:12px;font-family:monospace;"></div>
    </div>
  </div>
</div>

<style>
.avatar-upload-area {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  overflow: hidden;
  position: relative;
  cursor: pointer;
  border: 2px solid #e0e0e0;
}
.avatar-upload-area img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.avatar-upload-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s;
}
.avatar-upload-overlay .cui-icon {
  color: #fff;
  font-size: 24px;
}
.avatar-upload-area:hover .avatar-upload-overlay {
  opacity: 1;
}
.file-list {
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  min-height: 100px;
}
.file-list-empty {
  padding: 30px;
  text-align: center;
  color: #999;
}
.file-list-item {
  display: flex;
  align-items: center;
  padding: 10px 15px;
  border-bottom: 1px solid #f0f0f0;
}
.file-list-item:last-child {
  border-bottom: none;
}
.file-list-item .file-icon {
  width: 40px;
  height: 40px;
  background: #f5f5f5;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
}
.file-list-item .file-icon img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 4px;
}
.file-list-item .file-info {
  flex: 1;
}
.file-list-item .file-name {
  font-weight: 500;
  margin-bottom: 2px;
}
.file-list-item .file-size {
  font-size: 12px;
  color: #999;
}
.file-list-item .file-actions {
  display: flex;
  gap: 5px;
}
</style>

<script>
Catui.use(['upload', 'popup'], function(){
  
  // íŒŒì¼ í¬ê¸° í¬ë§·
  function formatSize(bytes){
    if(bytes === 0) return '0 Bytes';
    var k = 1024;
    var sizes = ['Bytes', 'KB', 'MB', 'GB'];
    var i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // ë¡œê·¸ í•¨ìˆ˜
  function log(msg, target){
    var el = document.getElementById(target || 'callbackLog');
    var time = new Date().toLocaleTimeString();
    el.innerHTML = '<div>[' + time + '] ' + msg + '</div>' + el.innerHTML;
  }

  // ì§„í–‰ë¥  í‘œì‹œ
  upload.render({
    elem: '#uploadProgress',
    url: '/api/upload',
    accept: 'file',
    choose: function(obj){
      document.getElementById('progressBar').style.display = 'block';
      document.querySelector('#progressBar .cui-progress-bar').style.width = '0%';
      document.getElementById('progressText').textContent = '0%';
      
      // ë°ëª¨: ê°€ìƒ ì§„í–‰ë¥  ì‹œë®¬ë ˆì´ì…˜
      var percent = 0;
      var interval = setInterval(function(){
        percent += Math.random() * 20;
        if(percent >= 100){
          percent = 100;
          clearInterval(interval);
          popup.msg('ì—…ë¡œë“œ ì™„ë£Œ (ì‹œë®¬ë ˆì´ì…˜)');
        }
        document.querySelector('#progressBar .cui-progress-bar').style.width = percent + '%';
        document.getElementById('progressText').textContent = Math.round(percent) + '%';
      }, 200);
    },
    progress: function(percent, idx, file){
      document.querySelector('#progressBar .cui-progress-bar').style.width = percent + '%';
      document.getElementById('progressText').textContent = percent + '%';
    }
  });

  // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
  upload.render({
    elem: '#uploadPreview',
    url: '/api/upload',
    accept: 'images',
    multiple: true,
    auto: false,
    choose: function(obj){
      var previewArea = document.getElementById('previewArea');
      previewArea.innerHTML = '';
      
      obj.preview(function(idx, file, result){
        var div = document.createElement('div');
        div.style.cssText = 'position:relative;';
        div.innerHTML = '<img src="' + result + '" style="width:100px;height:100px;object-fit:cover;border-radius:8px;border:1px solid #e0e0e0;">' +
          '<div style="font-size:11px;text-align:center;margin-top:4px;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + file.name + '</div>' +
          '<div style="font-size:10px;text-align:center;color:#999;">' + formatSize(file.size) + '</div>';
        previewArea.appendChild(div);
      });
    }
  });

  // ì•„ë°”íƒ€ ì—…ë¡œë“œ
  upload.render({
    elem: '#avatarUpload',
    url: '/api/upload',
    accept: 'images',
    acceptMime: 'image/jpeg,image/png',
    exts: 'jpg|jpeg|png',
    size: '2MB',
    choose: function(obj){
      obj.preview(function(idx, file, result){
        document.getElementById('avatarImg').src = result;
        popup.msg('í”„ë¡œí•„ ì‚¬ì§„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
      });
    },
    validateError: function(err){
      popup.msg(err.msg, { icon: 'warning' });
    }
  });

  // íŒŒì¼ ëª©ë¡ ê´€ë¦¬
  var fileManager = {
    files: {},
    counter: 0,
    render: function(){
      var listEl = document.getElementById('fileList');
      var keys = Object.keys(this.files);
      
      if(keys.length === 0){
        listEl.innerHTML = '<div class="file-list-empty"><i class="cui-icon">folder_open</i><br>íŒŒì¼ì„ ì¶”ê°€í•˜ì„¸ìš”</div>';
        return;
      }
      
      var html = '';
      var that = this;
      keys.forEach(function(key){
        var file = that.files[key];
        var isImage = file.type.startsWith('image/');
        var iconHtml = isImage ? '<img src="' + (file.preview || '') + '">' : '<i class="cui-icon">description</i>';
        
        html += '<div class="file-list-item" data-key="' + key + '">' +
          '<div class="file-icon">' + iconHtml + '</div>' +
          '<div class="file-info">' +
            '<div class="file-name">' + file.name + '</div>' +
            '<div class="file-size">' + formatSize(file.size) + '</div>' +
          '</div>' +
          '<div class="file-actions">' +
            '<button class="cui-btn cui-btn-xs cui-btn-primary btn-upload-single" data-key="' + key + '"><i class="cui-icon">upload</i></button>' +
            '<button class="cui-btn cui-btn-xs cui-btn-danger btn-remove-single" data-key="' + key + '"><i class="cui-icon">close</i></button>' +
          '</div>' +
        '</div>';
      });
      listEl.innerHTML = html;
      
      // ì´ë²¤íŠ¸ ë°”ì¸ë”©
      listEl.querySelectorAll('.btn-remove-single').forEach(function(btn){
        btn.onclick = function(){
          delete that.files[this.getAttribute('data-key')];
          that.render();
        };
      });
      listEl.querySelectorAll('.btn-upload-single').forEach(function(btn){
        btn.onclick = function(){
          var key = this.getAttribute('data-key');
          popup.msg(that.files[key].name + ' ì—…ë¡œë“œ ì‹œì‘ (ë°ëª¨)');
        };
      });
    },
    add: function(file, preview){
      var key = 'file_' + (++this.counter);
      this.files[key] = file;
      this.files[key].preview = preview;
      this.render();
    },
    clear: function(){
      this.files = {};
      this.render();
    }
  };
  fileManager.render();

  upload.render({
    elem: '#addFiles',
    url: '/api/upload',
    multiple: true,
    auto: false,
    choose: function(obj){
      obj.preview(function(idx, file, result){
        fileManager.add(file, result);
      });
    }
  });

  document.getElementById('uploadAll').onclick = function(){
    var count = Object.keys(fileManager.files).length;
    if(count === 0){
      popup.msg('ì—…ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤', { icon: 'warning' });
      return;
    }
    popup.msg(count + 'ê°œ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘ (ë°ëª¨)');
  };

  document.getElementById('clearAll').onclick = function(){
    fileManager.clear();
  };

  // ì¶”ê°€ ë°ì´í„° ì „ì†¡
  upload.render({
    elem: '#uploadWithData',
    url: '/api/upload',
    data: {
      category: function(){ return document.getElementById('category').value; },
      description: function(){ return document.getElementById('description').value; },
      timestamp: function(){ return Date.now(); }
    },
    choose: function(obj){
      var file = obj.getFiles()[0];
      var cat = document.getElementById('category').value;
      var desc = document.getElementById('description').value;
      
      document.getElementById('dataResult').innerHTML = 
        '<strong>ì „ì†¡ ë°ì´í„°:</strong><br>' +
        '- íŒŒì¼: ' + file.name + '<br>' +
        '- ì¹´í…Œê³ ë¦¬: ' + cat + '<br>' +
        '- ì„¤ëª…: ' + (desc || '(ì—†ìŒ)') + '<br>' +
        '- íƒ€ì„ìŠ¤íƒ¬í”„: ' + Date.now();
    }
  });

  // ì½œë°± ì¢…í•©
  upload.render({
    elem: '#uploadCallback',
    url: '/api/upload',
    multiple: true,
    number: 5,
    size: '10MB',
    before: function(file){
      log('ğŸ“¤ before: ' + file.name + ' ì—…ë¡œë“œ ì¤€ë¹„');
      return true;  // false ë°˜í™˜ ì‹œ ì·¨ì†Œ
    },
    choose: function(obj){
      var count = Object.keys(obj.getFiles()).length;
      log('ğŸ“ choose: ' + count + 'ê°œ íŒŒì¼ ì„ íƒë¨');
    },
    progress: function(percent, idx, file){
      log('ğŸ“Š progress: ' + file.name + ' - ' + percent + '%');
    },
    done: function(res, idx, upload){
      log('âœ… done: íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ');
    },
    error: function(idx, upload){
      log('âŒ error: ì—…ë¡œë“œ ì‹¤íŒ¨ (ì„œë²„ ì—†ìŒ - ë°ëª¨)');
    },
    allDone: function(obj){
      log('ğŸ‰ allDone: ì „ì²´ ' + obj.total + 'ê°œ ì¤‘ ì„±ê³µ ' + obj.successful + ', ì‹¤íŒ¨ ' + obj.aborted);
    },
    validateError: function(err){
      log('âš ï¸ validateError: ' + err.msg + ' (' + err.file.name + ')');
    }
  });
});
</script>
</div>
